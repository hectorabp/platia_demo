{
  "name": "platia_flow_demo",
  "nodes": [
    {
      "parameters": {
        "channels": "whatsapp_platia",
        "options": {}
      },
      "type": "n8n-nodes-base.redisTrigger",
      "typeVersion": 1,
      "position": [
        0,
        0
      ],
      "id": "1b59f60d-1133-46fa-a47d-2d7ad099c0c8",
      "name": "Redis Trigger",
      "credentials": {
        "redis": {
          "id": "uNXnZN2CEhTqKFU3",
          "name": "Redis account 3"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a778ebab-5115-4d27-965d-d96118fa8e4e",
              "name": "message",
              "value": "={{ $json.message }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        224,
        0
      ],
      "id": "affdd28d-3d51-4300-8804-dbbe57d34189",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://conversation_manager:5000/api/process_message",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={\"role\": \"user\", \"text\": \"{{ $json.message.message }}\"}"
            },
            {
              "name": "tokens",
              "value": "{\"prompt_tokens\": 0, \"completion_tokens\": 0, \"total_tokens\": 0}"
            },
            {
              "name": "send_data",
              "value": "{\"audio\": null, \"image\": null, \"location\": null, \"document\": null, \"video\": null}"
            },
            {
              "name": "phone",
              "value": "={{ $json.message.phone }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        656,
        0
      ],
      "id": "f551f66e-171c-491e-8d12-f695adeecbce",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "jsCode": "// n8n Function node\nreturn items.map(item => {\n  const json = item.json || {};\n  const conversation = json.conversation || {};\n  const messagesInput = conversation.message || [];\n\n  // Inicializamos arrays separados\n  const userMessages = [];\n  const systemMessages = [];\n\n  if (Array.isArray(messagesInput) && messagesInput.length > 0) {\n    for (const msg of messagesInput) {\n      const role = msg.role === 'system' ? 'system' :\n                   msg.role === 'assistant' ? 'system' : // tratamos assistant como system\n                   'user';\n\n      // Extraer texto\n      let text = '';\n      if (msg.content) {\n        if (Array.isArray(msg.content)) {\n          text = msg.content\n            .map(c => c.text ?? '')\n            .filter(t => t)\n            .join(' ');\n        } else if (typeof msg.content === 'string') {\n          text = msg.content;\n        }\n      }\n\n      if (!text) continue;\n\n      // Guardar en el array correspondiente\n      if (role === 'user') {\n        userMessages.push(text);\n      } else {\n        systemMessages.push(text);\n      }\n    }\n  } else {\n    // fallback mensaje √∫nico\n    const userText = json.message?.text ?? json.message ?? json.content ?? json.text ?? '';\n    if (userText) userMessages.push(String(userText));\n  }\n\n  // Guardamos en conversation\n  item.json.conversation = {\n    user: userMessages,\n    system: systemMessages,\n    session_id: conversation.session_id ?? String(Date.now()),\n    state: conversation.state ?? [],\n    transmitter: conversation.transmitter ?? json.transmitter ?? null\n  };\n\n  return item;\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        0
      ],
      "id": "5ff071d0-1d19-4911-983a-0b5ce5ee7c86",
      "name": "Code"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d55d2192-bea7-4d04-a5ab-06cb071f9337",
              "name": "message",
              "value": "={{ $json.message }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1456,
        0
      ],
      "id": "8bf6bbc3-1e76-4dd3-a14b-0eb8d307f722",
      "name": "Edit Fields2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3796fd17-7c4c-47c7-bca2-d24fc07ed7d7",
              "name": "title",
              "value": "Premio Emprendedor del A√±o (PEA)",
              "type": "string"
            },
            {
              "id": "f2f97180-f9d2-40ea-a8f5-4a03e03b921e",
              "name": "content",
              "value": "# **Farmalife ‚Äî descripci√≥n extendida (visi√≥n general)**\n\n**Farmalife** es una cadena nacional de farmacias orientada a ofrecer **salud accesible, asesor√≠a profesional y conveniencia**. Farmalife combina:\n\n* **Cobertura urbana focal** en Asunci√≥n, Lambar√© y San Lorenzo con 20 sucursales estrat√©gicas (10 Asunci√≥n / 3 Lambar√© / 7 San Lorenzo).\n\n* **Omnicanalidad**: tiendas f√≠sicas 24/7 (en puntos seleccionados), web con cat√°logo y e-commerce, pedido por WhatsApp y delivery urbano r√°pido (misma hora / 2 horas seg√∫n zona).\n\n* **Servicios cl√≠nicos anexos**: toma de presi√≥n, vacunatorio (vacunas estacionales), consejos farmac√©uticos (farmac√©utico presencial y por chat), gesti√≥n de recetas electr√≥nicas y programa de adherencia a tratamientos.\n\n* **Pol√≠tica de precios**: mezcla de marcas premium y gen√©ricos competitivos; promociones semanales (ej. ‚ÄúFin de Salud‚Äù con descuentos hasta 40%) y plan de fidelidad ‚ÄúVida+‚Äù con puntos y beneficios (env√≠o gratis desde un m√≠nimo y descuentos especiales en cumplea√±os).\n\n* **Responsabilidad social**: campa√±as peri√≥dicas de prevenci√≥n (hipertensi√≥n, diabetes), convenios con centros de salud y participaci√≥n en programas estatales cuando aplique.\n\n**Misi√≥n:** Facilitar el acceso responsable y confiable a medicamentos y productos de cuidado personal, cuidando la salud de las familias con asesor√≠a profesional y soluciones convenientes.  \n **Visi√≥n:** Ser la primera opci√≥n de farmacia en Asunci√≥n y Gran Asunci√≥n por atenci√≥n, precio y conveniencia.\n\n---\n\n# **3\\) Servicios operativos y modelo de atenci√≥n**\n\n* **Horario**: 18 sucursales con horario extendido 8:00‚Äì22:00; 2 sucursales emblem√°ticas (centro y Terminal) 24/7.\n\n* **Canales de venta**: web (cat√°logo \\+ carrito), venta por WhatsApp Business (cat√°logo integrado), telefon√≠a, y estaciones de autoservicio en sucursales grandes. Web: www.farmalife.com.py, redes sociales Facebook e instagram: @Farmalife\n\n* **Log√≠stica**: un centro de distribuci√≥n central en Gran Asunci√≥n (optimizar rotaci√≥n y reposici√≥n diaria), y alianza con couriers locales para entregas fuera de radio urbano.\n\n* **Talento**: cada sucursal con al menos 1 farmac√©utico titulado (turnos rotativos), cajero/a y un encargado de farmacia; entrenamientos trimestrales y protocolos de cumplimiento sanitario.\n\n---\n\n# **4\\) Direcciones**\n\n## **Asunci√≥n ‚Äî 10 sucursales**\n\n1. **Asunci√≥n Centro / Microcentro** ‚Äî Av. Mariscal L√≥pez 123 (esquina Rodr√≠guez de Francia) ‚Äî Sucursal Central (flagship, 24/7).\n\n2. **Villa Morra** ‚Äî Av. San Mart√≠n 2200 (frente a centro comercial) ‚Äî formato est√°ndar.\n\n3. **Ba√±ados (Cerro Cor√°)** ‚Äî Avda. Eusebio Ayala 3450 (casi Yegros) ‚Äî est√°ndar.\n\n4. **Barrio Obrero** ‚Äî Av. Choferes del Chaco 560 (c/ India Juliana) ‚Äî mini.\n\n5. **Madame Lynch** ‚Äî Av. Carlos A. L√≥pez 1800 (zona comercial) ‚Äî est√°ndar.\n\n6. **Manor√° / Salvador del Mundo** ‚Äî Av. Molas L√≥pez 2780 ‚Äî mini.\n\n7. **Terminal de √ìmnibus** ‚Äî Av. Fernando de la Mora 50 ‚Äî sucursal 24/7 (turnos nocturnos).\n\n8. **San Vicente / Rep√∫blica** ‚Äî Av. Espa√±a 900 (zona de cl√≠nicas) ‚Äî est√°ndar con vacunatorio.\n\n9. **Carmelitas** ‚Äî Av. General Santos 450 ‚Äî formato compacto.\n\n10. **San Jer√≥nimo / Centro M√©dico** ‚Äî Av. Primer Presidente 1350 (cercano a hospitales) ‚Äî est√°ndar.\n\n## **Lambar√© ‚Äî 3 sucursales**\n\n1. **Centro de Lambar√©** ‚Äî Av. Cerro Cora 210 (frente a plaza central) ‚Äî est√°ndar.\n\n2. **Villa Aurelia (l√≠mite Lambar√©-Asunci√≥n)** ‚Äî Av. Yegros 700 ‚Äî mini.\n\n3. **Lambar√© Sur / Ruta Luque** ‚Äî Ruta II (Carretera Central) km 9,5 ‚Äî est√°ndar (alto tr√°nsito).\n\n## **San Lorenzo ‚Äî 7 sucursales**\n\n1. **San Lorenzo Centro** ‚Äî Av. Mariscal L√≥pez 800 (cercano Municipalidad) ‚Äî flagship regional.\n\n2. **Universidad (zona UCA / UNA)** ‚Äî Av. Espa√±a 1200 ‚Äî mini (foco en estudiantes).\n\n3. **San Lorenzo Norte (Ruta 2\\)** ‚Äî Ruta 2, zona comercial km 8 ‚Äî est√°ndar.\n\n4. **Avenida Boggiani** ‚Äî Boggiani 450 ‚Äî mini.\n\n5. **Zona Hospitalaria** ‚Äî Av. Itaip√∫ 110 (cercano a centros de salud) ‚Äî est√°ndar con servicio de adherencia a tratamientos.\n\n6. **Barrio Industrial** ‚Äî Calle 12 c/ Av. San Lorenzo ‚Äî formato industrial (turnos) para trabajadores.\n\n7. **San Lorenzo Este (mall local)** ‚Äî local en centro comercial peque√±o ‚Äî est√°ndar.\n\n---\n\n# **5\\) Lista de productos**\n\n1. Paracetamol 500 mg ‚Äî caja x20 tabletas ‚Äî **Gs. 8.500**\n\n2. Ibuprofeno 400 mg ‚Äî caja x20 ‚Äî **Gs. 18.000**\n\n3. Aspirina (√°cido acetilsalic√≠lico) 100 mg ‚Äî caja x24 ‚Äî **Gs. 10.000**\n\n4. Omeprazol 20 mg ‚Äî caja x28 c√°psulas ‚Äî **Gs. 35.000**\n\n5. Ranitidina (o antacid gen√©rico H2) ‚Äî caja x20 ‚Äî **Gs. 28.000**\n\n6. Salbutamol inhalador 100 mcg ‚Äî **Gs. 85.000**\n\n7. Loratadina 10 mg ‚Äî caja x10 ‚Äî **Gs. 22.000**\n\n8. Cetirizina 10 mg ‚Äî caja x10 ‚Äî **Gs. 20.000**\n\n9. Amoxicilina 500 mg ‚Äî caja x16 c√°psulas ‚Äî **Gs. 60.000**\n\n10. Amoxicilina \\+ √°cido clavul√°nico 875/125 mg ‚Äî caja x8 ‚Äî **Gs. 120.000**\n\n11. Metronidazol 500 mg ‚Äî caja x12 ‚Äî **Gs. 25.000**\n\n12. Azitromicina 500 mg ‚Äî caja x3 ‚Äî **Gs. 45.000**\n\n13. Diclofenac 50 mg ‚Äî caja x20 ‚Äî **Gs. 24.000**\n\n14. Naproxeno 500 mg ‚Äî caja x20 ‚Äî **Gs. 30.000**\n\n15. Hidrocortisona crema 1% ‚Äî tubo 30 g ‚Äî **Gs. 22.000**\n\n16. Crema antibi√≥tica (mupirocina 2%) ‚Äî tubo 15 g ‚Äî **Gs. 55.000**\n\n17. Antis√©ptico (clorhexidina 0,12%) ‚Äî frasco 250 ml ‚Äî **Gs. 28.000**\n\n18. Term√≥metro digital ‚Äî **Gs. 145.000**\n\n19. Tiritas / vendajes surtidos (pack) ‚Äî **Gs. 8.500**\n\n20. Jeringas 5 ml (pack x10) ‚Äî **Gs. 12.000**\n\n21. Insulina (bol√≠grafo o vial, seg√∫n marca) ‚Äî **Gs. 150.000** (modelo gen√©rico)\n\n22. Lancetas para glucemia (pack 50\\) ‚Äî **Gs. 35.000**\n\n23. Test de glucosa (tiras, pack 50\\) ‚Äî **Gs. 220.000**\n\n24. Multivitam√≠nico adulto (30 c√°psulas) ‚Äî **Gs. 85.000**\n\n25. Vitamina C 500 mg (pack 30\\) ‚Äî **Gs. 35.000**\n\n26. √Åcido f√≥lico 5 mg (pack 30\\) ‚Äî **Gs. 18.000**\n\n27. Suero fisiol√≥gico 500 ml ‚Äî **Gs. 12.000**\n\n28. Soluci√≥n para lentes de contacto (360 ml) ‚Äî **Gs. 75.000**\n\n29. Crema hidratante corporal 400 ml (marca gen√©rica) ‚Äî **Gs. 45.000**\n\n30. Champ√∫ anticaspa 250 ml ‚Äî **Gs. 35.000**\n\n31. Protector solar SPF 50 (tubo 100 ml) ‚Äî **Gs. 85.000**\n\n32. Colirio lubricante (artificial tears) 10 ml ‚Äî **Gs. 28.000**\n\n33. Pastillas para la garganta (antis√©pticas) ‚Äî frasco ‚Äî **Gs. 22.000**\n\n34. Jarabe para la tos (adultos) 120 ml ‚Äî **Gs. 28.000**\n\n35. Antidiarreico (loperamida) ‚Äî caja x10 ‚Äî **Gs. 14.000**\n\n36. Sales de rehidrataci√≥n oral (SRO) ‚Äì sachet x10 ‚Äî **Gs. 12.000**\n\n37. Crema/gel antiinflamatorio t√≥pico (diclofenac gel 1%) ‚Äî tubo 100 g ‚Äî **Gs. 42.000**\n\n39. Anticonceptivos orales combinados (paquete 21\\) ‚Äî **Gs. 60.000**\n\n40. Anticonceptivo de emergencia ‚Äî blister √∫nico ‚Äî **Gs. 40.000**\n\n41. Test de embarazo (cassette) ‚Äî **Gs. 28.000**\n\n42. Cremas antif√∫ngicas (clotrimazol 1%) ‚Äî tubo 20 g ‚Äî **Gs. 18.000**\n\n43. Gel yodado (povidona yodada 10%) ‚Äî frasco 125 ml ‚Äî **Gs. 9.500**\n\n44. Sanguchera termica / bolsa isot√©rmica peque√±a (para transporte de medicamentos) ‚Äî **Gs. 55.000**\n\n45. Analg√©sico/antigripal combinado (paracetamol \\+ cafe√≠na \\+ otros) ‚Äî caja x10 ‚Äî **Gs. 28.000**\n\n46. Colch√≥n / almohadilla t√©rmica port√°til (peque√±a) ‚Äî **Gs. 95.000**\n\n47. Anti√°cido (tabletas masticables, Bicarbonato o combinados) ‚Äî frasco 30 ‚Äî **Gs. 18.000**\n\n48. Suplemento de calcio \\+ vitamina D ‚Äî frasco 60 ‚Äî **Gs. 95.000**\n\n49. Probi√≥ticos (30 c√°psulas) ‚Äî **Gs. 120.000**\n\n50. Producto de cuidado √≠ntimo (toallitas/gel √≠ntimo) ‚Äî **Gs. 28.000**\n\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        304,
        480
      ],
      "id": "0db94e86-6c00-4a46-a19c-5472a4505dad",
      "name": "Edit Fields3"
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        544,
        480
      ],
      "id": "59fa9cc2-2461-4c7f-846f-b2045b54450e",
      "name": "Supabase Vector Store",
      "credentials": {
        "supabaseApi": {
          "id": "0wCgmasn0wKuXfYy",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        480,
        720
      ],
      "id": "6c51000f-fc62-4e93-836f-1cd18ad77502",
      "name": "Embeddings OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "krp9PufNs7D16WmX",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1,
      "position": [
        688,
        704
      ],
      "id": "82ee2abd-0da1-4ceb-b9c7-5adfc3885e00",
      "name": "Default Data Loader"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.textSplitterCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        784,
        928
      ],
      "id": "8fdd4100-90ba-4e32-baf9-b8149b68b327",
      "name": "Character Text Splitter"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        1008,
        416
      ],
      "id": "baf96b6f-5469-48a8-b64a-dbfbadf00e30",
      "name": "Embeddings OpenAI1",
      "credentials": {
        "openAiApi": {
          "id": "krp9PufNs7D16WmX",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolName": "Nodo_conocimiento_Farmalife",
        "toolDescription": "Usa esto para obtener informaci√≥n de la cadena de farmacias Farmalife",
        "tableName": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        1024,
        208
      ],
      "id": "b0d18b08-20e3-400b-b3e1-38e7af6f89a2",
      "name": "Nodo_Conocimiento_PEA",
      "credentials": {
        "supabaseApi": {
          "id": "0wCgmasn0wKuXfYy",
          "name": "Supabase account 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "publish",
        "channel": "whatsapp_platia",
        "messageData": "={\"transmitter\": \"N8N\",\"phone\": {{ $json.conversation.transmitter }},\"name\": \"\",\"message\": \"{{ $('Edit Fields1').item.json.message.content.text }}\",\"send\": {}}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2080,
        0
      ],
      "id": "effa5b7e-2c9f-417d-968e-a3f20af525b2",
      "name": "Redis",
      "credentials": {
        "redis": {
          "id": "uNXnZN2CEhTqKFU3",
          "name": "Redis account 3"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "ce0aafe1-85ed-4e6f-b880-600e97d93793",
              "leftValue": "={{ $json.message.transmitter }}",
              "rightValue": "whatsapp_platia",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "bf2e4337-4b11-4136-93d7-75523a83b5db",
              "leftValue": "={{ $json.message.message }}",
              "rightValue": "[Mensaje no textual]",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        432,
        0
      ],
      "id": "c05fb56a-922d-4987-9add-6b4f8e05f7aa",
      "name": "If"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://conversation_manager:5000/api/process_message",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={\"role\": \"{{ $('Edit Fields2').item.json.message.role }}\", \"text\": \"{{ $json.message.content.text }}\"}"
            },
            {
              "name": "tokens",
              "value": "{\"prompt_tokens\": 0, \"completion_tokens\": 0, \"total_tokens\": 0}"
            },
            {
              "name": "send_data",
              "value": "{\"audio\": null, \"image\": null, \"location\": null, \"document\": null, \"video\": null}"
            },
            {
              "name": "phone",
              "value": "={{ $json.message.content.transmitter }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1872,
        0
      ],
      "id": "277a8186-a837-4cac-9b98-a62f6e23acce",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-5-mini-2025-08-07",
          "mode": "list",
          "cachedResultName": "GPT-5-MINI-2025-08-07"
        },
        "messages": {
          "values": [
            {
              "content": "=={{ $json.conversation.user }}"
            },
            {
              "content": "=Eres un agente de atenci√≥n al cliente de la farmacia **Farmalife**.  \nTu tarea es responder siempre de manera **corta, clara y directa**, sin dar explicaciones largas ni textos extensos.  \n\nUsa la informaci√≥n relevante que se te proporciona (En contexto de Nodo_Conocimiento_Farmalife) solo si es necesario para responder la consulta.  \n\nReglas principales:\n- Lee toda la conversaci√≥n del `user` y `system` para tener contexto. (Cada mensaje est√° separado por comas \",\". Ejemplo: user[Hola,¬øTienen paracetamol?] en ese ejemplo hay 2 mensajes distintos: uno es \"Hola\" y el otro \"¬øTienen paracetamol?\". No est√°n en la misma oraci√≥n pero forman el contexto de la conversaci√≥n).  \n- **Nunca repitas informaci√≥n que ya diste en la conversaci√≥n**, salvo que el usuario lo pida expl√≠citamente.  \n- Si el usuario responde con un cierre (ej: \"ok\", \"gracias\", \"dale\", \"perfecto\"), solo responde con un breve mensaje de cierre amable como:  \n  - \"¬°Genial, quedo a disposici√≥n! üôå\"  \n  - \"¬°Perfecto, gracias por contactarnos! üòä\"  \n  - o no responder nada, si el contexto ya est√° cerrado.  \n- Si el usuario solo saluda al inicio, responde con un saludo breve y cordial: \"Hola, ¬øen qu√© puedo ayudarle? üòä\".  \n- No concatenes respuestas anteriores ni repitas lo que ya est√° en el historial del `system`.  \n- Mencion√° promociones o delivery **una sola vez** durante toda la conversaci√≥n.  \n- Responde siempre seg√∫n la documentaci√≥n de Farmalife y el contexto de la conversaci√≥n.  \n- Saluda solo una vez en toda la sesi√≥n.\n\n### Proceso de venta (si el cliente pide un producto):\n1. Confirmar disponibilidad y precio.  \n   Ejemplo: \"S√≠, tenemos Paracetamol 500 mg x20 ‚Üí Gs. 8.500. ¬øQuer√©s delivery o pasar a retirar en sucursal?\"  \n2. Si elige **delivery**:  \n   - Preguntar ubicaci√≥n para coordinar env√≠o.  \n   - Informar costo fijo: \"El costo del delivery es Gs. 25.000 en todo el Departamento Central.\"  \n   - Confirmar que el repartidor se pondr√° en contacto.  \n3. Preguntar forma de pago:  \n   - Opci√≥n efectivo.  \n   - Opci√≥n tarjeta (d√©bito o cr√©dito).  \n4. Cerrar con confirmaci√≥n:  \n   \"Perfecto, tu pedido est√° registrado. El delivery se comunicar√° contigo en breve üôå\".  \n5. Si el user ya confirmo que va a comprar no lo vuelvas a pedir que confirme, en todo caso preguntale si va a querer factura, en caso de que quiera pedile RUC, Nombre y Apellido para la factura.\n### Formato de salida obligatorio:\nSiempre responde en **JSON v√°lido** con este formato exacto:\n\n{\n  \"text\": \"Aqu√≠ va la respuesta breve y amable\",\n  \"transmitter\": \"{{ $('Code').item.json.conversation.transmitter }}\"\n}\n\n### Preguntas frecuentes (usar solo si el usuario lo pregunta):\n¬øTienen delivery? ‚Üí S√≠, hacemos env√≠os en Asunci√≥n, Lambar√© y San Lorenzo.  \n¬øD√≥nde est√°n las sucursales? ‚Üí Tenemos 10 en Asunci√≥n, 3 en Lambar√© y 7 en San Lorenzo.  \n¬øTienen paracetamol? ‚Üí S√≠, Paracetamol 500 mg caja x20 ‚Üí Gs. 8.500.  \n¬øTienen ibuprofeno? ‚Üí S√≠, Ibuprofeno 400 mg caja x20 ‚Üí Gs. 18.000.  \n¬øHorario de atenci√≥n? ‚Üí De 8:00 a 22:00 en la mayor√≠a de las sucursales; dos locales funcionan 24/7.  \n¬øTienen promociones? ‚Üí S√≠, lanzamos descuentos semanales en medicamentos y cuidado personal.  \n",
              "role": "system"
            },
            {
              "content": "=={{ $json.conversation.system }}",
              "role": "assistant"
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        1088,
        0
      ],
      "id": "1d045410-34c2-4e6b-9142-6d09d279bc6d",
      "name": "Message a model",
      "credentials": {
        "openAiApi": {
          "id": "krp9PufNs7D16WmX",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "65f7d8a9-97fc-4723-98ed-8ca974ea16e9",
              "name": "message.content",
              "value": "={{ $json.message.content }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1664,
        0
      ],
      "id": "94272fe8-7c03-4085-80ae-6c396c27917b",
      "name": "Edit Fields1"
    }
  ],
  "pinData": {},
  "connections": {
    "Redis Trigger": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Message a model",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields3": {
      "main": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Character Text Splitter": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI1": {
      "ai_embedding": [
        [
          {
            "node": "Nodo_Conocimiento_PEA",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Nodo_Conocimiento_PEA": {
      "ai_tool": [
        [
          {
            "node": "Message a model",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields2": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message a model": {
      "main": [
        [
          {
            "node": "Edit Fields2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "4713f235-f390-4573-847a-ae0da6bc6c71",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "92c6a3c05e6b3f1aaacba8d64b3df43b9c41210374aae38fc578c665c3a3e353"
  },
  "id": "3rZyv4BytY4NtSoH",
  "tags": []
}