<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Panel WhatsApp QR</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .qr-img {
            max-width: 300px;
            margin: 20px auto;
            display: block;
        }
        .fade-out {
            transition: opacity 0.5s ease;
            opacity: 0;
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div id="alert-container"></div>
            <div class="card shadow">
                <div class="card-body text-center">
                    <h3 class="mb-4">Panel de Autenticación WhatsApp</h3>
                    <div id="session-info"></div>
                    <div id="qr-section" class="my-4"></div>
                    <button id="logout-btn" class="btn btn-danger d-none">Cerrar sesión</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>

const qrSection = document.getElementById('qr-section');
const sessionInfo = document.getElementById('session-info');
const logoutBtn = document.getElementById('logout-btn');
const alertContainer = document.getElementById('alert-container');

function showAlert(msg, type = 'success', duration = 2500) {
    alertContainer.innerHTML = `<div class="alert alert-${type} mb-3" role="alert">${msg}</div>`;
    if (duration > 0) {
        setTimeout(() => {
            alertContainer.innerHTML = '';
        }, duration);
    }
}


function renderSession(isActive) {
    if (isActive) {
        sessionInfo.innerHTML = `<div class='alert alert-success'>Sesión iniciada con éxito.</div>`;
        qrSection.innerHTML = '';
        logoutBtn.classList.remove('d-none');
    } else {
        sessionInfo.innerHTML = `<div class='alert alert-warning'>No hay sesión activa. Escanee el QR para iniciar sesión.</div>`;
        fetch('/whatsapp/qr?_=' + Date.now())
            .then(resp => {
                if (resp.ok) return resp.blob();
                throw new Error('QR no disponible');
            })
            .then(blob => {
                const url = URL.createObjectURL(blob);
                qrSection.innerHTML = `<img src='${url}' alt='QR' class='qr-img'/>`;
            })
            .catch(() => {
                qrSection.innerHTML = `<div class='alert alert-secondary'>QR no disponible. Espere unos segundos y recargue.</div>`;
            });
        logoutBtn.classList.add('d-none');
    }
}


function checkStatus(showCredsMsg = false) {
    fetch('/whatsapp/status?_=' + Date.now())
        .then(resp => resp.json())
        .then(data => {
            renderSession(data.success);
            if (showCredsMsg && data.success) {
                showAlert('Credenciales guardadas exitosamente. ¡Sesión iniciada!', 'success');
            }
        })
        .catch(() => {
            renderSession(false);
            showAlert('Error consultando el estado de la sesión.', 'danger');
        });
}


logoutBtn.addEventListener('click', () => {
    fetch('/whatsapp/logout')
        .then(resp => resp.json())
        .then(data => {
            if (data.success) {
                showAlert('Sesión cerrada correctamente.', 'success');
                setTimeout(() => checkStatus(), 1000);
            } else {
                showAlert(data.message || 'Error al cerrar sesión.', 'danger');
            }
        })
        .catch(() => showAlert('Error al cerrar sesión.', 'danger'));
});

// Polling para actualizar el estado cada 3 segundos
globalThis.lastSession = false;
setInterval(() => {
    fetch('/whatsapp/status?_=' + Date.now())
        .then(resp => resp.json())
        .then(data => {
            if (data.success !== globalThis.lastSession) {
                // Si el estado cambió, mostrar mensaje de credenciales guardadas
                if (data.success) {
                    checkStatus(true);
                } else {
                    checkStatus();
                }
                globalThis.lastSession = data.success;
            }
        });
}, 3000);

// Inicial
checkStatus();
</script>
</body>
</html>
